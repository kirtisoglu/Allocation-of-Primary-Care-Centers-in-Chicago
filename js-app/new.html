<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Tree Animation - Blocks + Districts</title>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.98);
            padding: 12px 16px;
            border: 1px solid #ccc;
            font-size: 14px;
            z-index: 1001;
            user-select: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #controls button {
            padding: 6px 12px;
            margin-right: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            border: 1px solid #999;
            border-radius: 4px;
            background: #f5f5f5;
            font-size: 13px;
            transition: background 0.2s;
        }

        #controls button:hover {
            background: #e0e0e0;
        }

        #controls input {
            padding: 4px 8px;
            margin-right: 8px;
            font-size: 13px;
            border: 1px solid #999;
            border-radius: 4px;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: block;
            background: #000;
            z-index: 0;
        }

        #tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #aaa;
            padding: 8px 10px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 1002;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        #sidebar {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            border-left: 1px solid #ccc;
            padding: 12px 16px;
            box-sizing: border-box;
            z-index: 1001;
            overflow-y: auto;
        }

        #sidebar h2 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
        }

        .status {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            margin-top: 12px;
            font-size: 12px;
            line-height: 1.4;
        }

        .status.error {
            background: #ffebee;
            border-color: #ef5350;
            color: #c62828;
        }

        .status.success {
            background: #e8f5e9;
            border-color: #66bb6a;
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <div id="controls">
        <div style="margin-bottom: 8px;">
            <button id="playBtn">▶ Play</button>
            <button id="pauseBtn">⏸ Pause</button>
            <button id="stopBtn">⏹ Stop</button>
            <button id="resetViewBtn">Reset View</button>
        </div>
        <div style="margin-bottom: 8px;">
            <button id="toggleTreeBtn">Hide Tree</button>
            <button id="toggleDistrictsBtn">Hide Districts</button>
        </div>
        <div>
            <label>Speed:</label>
            <input type="range" id="speedSlider" min="0.5" max="3" step="0.5" value="1" style="width: 100px;">
            <span id="speedLabel">1x</span>
        </div>
        <div style="margin-top: 8px;">
            <label>Iteration:</label>
            <input type="number" id="iterationInput" min="0" value="0" style="width: 60px;">
            <button id="goBtn">Go</button>
        </div>
        <div style="margin-top: 8px;">
            <label><input type="checkbox" id="debugMode"> Debug Mode</label>
        </div>
    </div>

    <aside id="sidebar">
        <h2>Animation Status</h2>

        <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #eee;">
            <h3 style="font-size: 12px; font-weight: 600; color: #666; margin: 0 0 8px 0;">TREE METADATA (Iteration
                <span id="currentIter">0</span>)
            </h3>
            <div id="treeMetadata" style="font-size: 12px; line-height: 1.6;"></div>
        </div>

        <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #eee;">
            <h3 style="font-size: 12px; font-weight: 600; color: #666; margin: 0 0 8px 0;">DISTRICT METADATA</h3>
            <div id="districtMetadata" style="font-size: 12px; line-height: 1.6;"></div>
        </div>

        <div>
            <h3 style="font-size: 12px; font-weight: 600; color: #666; margin: 0 0 8px 0;">STATUS LOG</h3>
            <div id="statusPanel" style="font-size: 11px; line-height: 1.4; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </aside>

    <canvas id="graphCanvas"></canvas>
    <div id="tooltip"></div>

    <!-- THIS IS THE MAIN MODULE THAT IMPORTS AND USES ALL OTHER MODULES -->
    <script type="module">
        // Import all modules
        import { CONFIG, VISUAL } from './js/config.js';
        import { Logger } from './js/logger.js';
        import { DataLoader } from './js/dataLoader.js';
        import { Renderer } from './js/renderer.js';
        import { ToleranceChecker } from './js/toleranceChecker.js';
        import { ViewManager } from './js/viewManager.js';
        import { InputHandler } from './js/inputHandler.js';
        import { AnimationController } from './js/animationController.js';

        // ============================================================
        // STATE - Shared across all modules
        // ============================================================
        const state = {
            iteration: 0,
            isPlaying: false,
            isPaused: false,
            animationSpeed: 1.0,

            blocksPaths: [],
            blocksBounds: null,
            centroidMaps: {
                byGeoID20: new Map(),
                byGeoID: new Map(),
                byFeatId: new Map(),
            },
            blockIdToFeature: new Map(),  // blockId -> feature for district coloring

            nodes: [],
            links: [],
            nodesById: {},
            rootId: null,
            metadata: null,

            districts: new Map(),
            nodeColorOverrides: new Map(),
            districtBlockColors: new Map(),  // blockId -> color (fixed across iterations)
            blockIdToGeometry: new Map(),    // blockId -> geometry for rendering

            // Visibility toggles
            showTree: true,
            showDistricts: true,

            transform: { x: 0, y: 0, k: 1, angle: 0 },
            initialTransform: null,
            center: { x: 0, y: 0 },
            flipX: false,

            highlightNodeId: null,
            highlightUntil: 0,
        };

        // ============================================================
        // DOM ELEMENTS
        // ============================================================
        const canvas = document.getElementById("graphCanvas");
        const statusPanel = document.getElementById("statusPanel");
        const tooltip = document.getElementById("tooltip");

        // ============================================================
        // INSTANTIATE ALL MODULES
        // ============================================================
        const logger = new Logger(statusPanel, CONFIG);
        const dataLoader = new DataLoader(logger);
        const renderer = new Renderer(canvas, CONFIG, VISUAL);
        const toleranceChecker = new ToleranceChecker();
        const viewManager = new ViewManager(canvas, CONFIG);
        const inputHandler = new InputHandler(canvas, viewManager);
        const animationController = new AnimationController(dataLoader, logger, CONFIG);

        // ============================================================
        // HELPER FUNCTIONS
        // ============================================================
        function resize() {
            canvas.width = innerWidth;
            canvas.height = innerHeight;
            redraw();
        }

        function redraw() {
            renderer.draw(state, (node) => toleranceChecker.isWithinTolerance(node, state.metadata));
        }

        // ============================================================
        // EVENT LISTENERS - UI CONTROLS
        // ============================================================
        document.getElementById("playBtn").addEventListener("click", () => {
            animationController.play(state, redraw, viewManager);
        });

        document.getElementById("pauseBtn").addEventListener("click", () => {
            animationController.pause(state);
        });

        document.getElementById("stopBtn").addEventListener("click", () => {
            animationController.stop(state, redraw);
        });

        document.getElementById("resetViewBtn").addEventListener("click", () => {
            if (state.initialTransform) {
                state.transform = { ...state.initialTransform };
                redraw();
                logger.log("View reset");
            }
        });

        document.getElementById("speedSlider").addEventListener("change", e => {
            state.animationSpeed = parseFloat(e.target.value);
            document.getElementById("speedLabel").textContent = `${state.animationSpeed}x`;
            logger.log(`Speed: ${state.animationSpeed}x`);
        });

        document.getElementById("goBtn").addEventListener("click", async () => {
            const targetIter = parseInt(document.getElementById("iterationInput").value, 10);
            if (isNaN(targetIter) || targetIter < 0) {
                logger.warn("Invalid iteration number");
                return;
            }
            await animationController.jumpToIteration(targetIter, state, redraw, viewManager, state.centroidMaps);
        });

        document.getElementById("debugMode").addEventListener("change", e => {
            CONFIG.debug = e.target.checked;
            logger.log(`Debug mode: ${CONFIG.debug ? "ON" : "OFF"}`);
        });

        document.getElementById("toggleTreeBtn").addEventListener("click", e => {
            state.showTree = !state.showTree;
            e.target.textContent = state.showTree ? "Hide Tree" : "Show Tree";
            logger.log(`Tree: ${state.showTree ? "visible" : "hidden"}`);
            redraw();
        });

        document.getElementById("toggleDistrictsBtn").addEventListener("click", e => {
            state.showDistricts = !state.showDistricts;
            e.target.textContent = state.showDistricts ? "Hide Districts" : "Show Districts";
            logger.log(`Districts: ${state.showDistricts ? "visible" : "hidden"}`);
            redraw();
        });

        // ============================================================
        // MOUSE & INPUT LISTENERS
        // ============================================================
        inputHandler.attachMouseListeners(canvas, state, viewManager, redraw, state.nodes, toleranceChecker, state.metadata, tooltip);

        addEventListener('resize', resize);

        // ============================================================
        // INITIALIZATION
        // ============================================================
        async function init() {
            try {
                logger.updateStatus("Initializing...", "info");
                // CHANGE START
                const { blocksBounds, detectedSwap } = await dataLoader.loadBlocks(state.blocksPaths, state.centroidMaps);
                state.blocksBounds = blocksBounds; // <--- Store bounds in state
                // CHANGE END

                // Set initial view transformation based on loaded blocks bounds
                viewManager.autoCenterAndScale(state); // <--- Call ViewManager to calculate initial transform

                resize(); // resize calls redraw()
                redraw(); // The first draw should now use the correct transform

                // Detect max iterations
                let maxIter = 1; // Initialize a variable to track the max iteration

                for (let i = 1; i < 10000; i++) { // Increased limit for safety
                    const response = await fetch(`data/trees/tree_${i}.json`, { method: "HEAD" });

                    if (response.ok) {
                        // File exists, update the max iteration
                        maxIter = i;
                    } else if (response.status === 404) {
                        // File not found (404 is the expected break condition)
                        break;
                    } else {
                        // Handle other errors (e.g., server error)
                        logger.warn(`Error checking file tree_${i}.json: Status ${response.status}`);
                        break;
                    }
                }

                // Store the determined max iteration in the state
                state.maxIteration = maxIter;
                logger.log(`Ready! Max iterations: ${state.maxIteration}`, "success");

            } catch (err) {
                logger.warn(`Init failed: ${err.message}`);
            }
        }

        init();
    </script>
</body>

</html>